# express-weather-api c Redis
Взаимодействие сервиса погоды с `redis` проходит через `docker-compose`

## Подготовка

Указать в .env **SECRET_KEY**
```
// .env

SECRET_KEY=**KEY**
```

Создать сеть для контейнеров `weather_net`:
```
docker network create weather_net
```

Справка имен всех контейнеров, которые будут использоваться:
```
weather (сервис погоды)
cluster (для подключения остальных в кластер, закрывается после создания подключения или при ошибке)
m_a (master a), m_b, m_c
r_a (replica a), r_b, r_c
```

Из директории `./redis` запустить `docker-compose` (_не стоит смотреть на ошибки, этот запуск нужен только, чтобы узнать на каких __адресах__ поднимаются контейнеры мастеров и реплик_)

Далее, в другом терминале (__не останавливая__ `docker-compose`), узнать адреса можно командой (__для каждого контейнера__):
```
docker container inspect m_a
``` 

Но можно воспользоваться скриптом:
```
bach ./log.sh
```

Команда выше создаст файл `log.txt`, который можно отфильтровать (примерный фильтр - `"IPAddress": "1`) и узнать адреса контейнеров, запущенных на соответствующих портах (порты в объекте - `Ports`):
```
172.18.0.7 -> 6379
172.18.0.6 -> 6380
172.18.0.5 -> 6381
172.18.0.4 -> 6382
172.18.0.3 -> 6383
172.18.0.2 -> 6384
```

Далее надо внести эти ip-адреса в, соответствующие портам и контейнерам, файлы конфигурации m_a.conf, m_b.conf, ...
```
// Пример одного файла - m_a.conf

bind                        0.0.0.0
protected-mode              no
port                        6379
pidfile                     /var/run/redis_6379.pid
cluster-enabled             yes
cluster-config-file 	    nodes-6379.conf
cluster-node-timeout 	    15000
cluster-announce-ip         172.18.0.7                  // <-- Сюда
cluster-announce-port       6379
cluster-announce-bus-port   16379
```

Остановим `docker-compose` через `Ctrl+C`, дождемся остановки всех контейнеров и удалим их: 
```
docker-compose rm
```

Теперь внесем найденные адреса в файл `docker-compose.yml`:
```
  cluster:
    image: redis
    network_mode: weather_net
    container_name: cluster
    command: sh -c "redis-cli --cluster create 172.18.0.7:6379 172.18.0.6:6380 172.18.0.5:6381 172.18.0.4:6382 172.18.0.3:6383 172.18.0.2:6384 --cluster-replicas 1 --verbose --cluster-yes"
    // ^^^^^^^^^^ сюда ^^^^^^^^^^
```

## Запуск
Из директории `./redis` введите:
```
docker-compose build && docker-compose up
```

## Новые конечные точки
* __PUT__ /v1/current - записать в redis погоду для городов
    ```
    // Пример body

    {
        "Moscow": 23
    }
    ```

* __PUT__ /v1/forecast - записать в redis прогноз \
    ```
    // Пример body

    {
        "Moscow": {
            "time": 1653523200,
            "temp": 25
        }
    }
    ```

## Мониторинг данных в redis-контейнерах
Чтобы посмотреть что лежит в контейнерах, нужно зайти в каждый по отдельности:
```
docker exec -it m_a bash
```

Зайти в `redis-cli` и __ввести команду__ `KEYS *`:

```
redis-cli           // <-- Для m_a
redis-cli -p 6380   // <-- Для остальных (пример для m_b)
```

## Отказоустойчивость
Чтобы проверить функционирование кластера после отказа одного из узлов, принудительно остановим один контейнер:
```
docker stop m_b
```

Посмотреть роли узлов можно командой `CLUSTER NODES` в `redis-cli`:
```
1ef2d349ea2e48349c3b48555f9a9540779eee94 172.18.0.2:6384@16384 slave 9c4a3f70134da5a648b0f1ba78b741d960e3c773 0 1653163536100 2 connected
c1e790e2ed36aed25312dcfe29681b2384d8ed22 172.18.0.3:6383@16383 slave 4252f15483104deb87435230784dcd96a374bb80 0 1653163535000 1 connected
4252f15483104deb87435230784dcd96a374bb80 172.18.0.7:6379@16379 myself,master - 0 1653163533000 1 connected 0-5460
00d6c4f0078681643bdf2608269ea5a831fa0f6c 172.18.0.4:6382@16382 slave a6b24fc8b475c86b35ff8f380c749690d4d06ac6 0 1653163535000 3 connected
9c4a3f70134da5a648b0f1ba78b741d960e3c773 172.18.0.6:6380@16380 master - 0 1653163534000 2 connected 5461-10922
a6b24fc8b475c86b35ff8f380c749690d4d06ac6 172.18.0.5:6381@16381 master - 0 1653163537103 3 connected 10923-16383
```
